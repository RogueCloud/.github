# Repo-specific approval configuration for issueops-approvals
# Multi-environment deployment approval flow: dev â†’ qa â†’ stage â†’ prod

version: 1

defaults:
  timeout: 72h
  allow_self_approval: true
  issue_labels:
    - approval-required
    - deployment

policies:
  # Anyone on the team can approve dev
  developers:
    approvers: [jamengual]
    min_approvals: 1

  # QA team for QA environment
  qa-team:
    approvers: [jamengual]
    min_approvals: 1

  # Tech leads for staging
  tech-leads:
    approvers: [jamengual]
    min_approvals: 1

  # Senior engineers + security for production
  production-approvers:
    approvers: [jamengual]
    require_all: true

workflows:
  # Progressive deployment pipeline - single issue tracks all environments
  deploy:
    description: "Deploy through all environments (dev â†’ qa â†’ stage â†’ prod)"
    require:
      - policy: developers  # Initial approval to start pipeline
    pipeline:
      track_prs: true
      track_commits: true
      stages:
        - name: dev
          environment: development
          policy: developers
          on_approved: "âœ… **DEV** deployment approved! Proceeding to QA..."
        - name: qa
          environment: qa
          policy: qa-team
          on_approved: "âœ… **QA** deployment approved! Proceeding to STAGING..."
        - name: stage
          environment: staging
          policy: tech-leads
          on_approved: "âœ… **STAGING** deployment approved! Ready for PRODUCTION..."
        - name: prod
          environment: production
          policy: production-approvers
          on_approved: "ðŸš€ **PRODUCTION** deployment complete!"
          create_tag: true
          is_final: true
    on_approved:
      close_issue: true
      comment: |
        ðŸŽ‰ **Deployment Complete!**

        Version `{{version}}` has been deployed to all environments.

  # Individual environment workflows (for manual control)
  deploy-dev:
    description: "Deploy to DEV only"
    require:
      - policy: developers
    on_approved:
      close_issue: true
      comment: "âœ… DEV deployment approved!"

  deploy-qa:
    description: "Deploy to QA only"
    require:
      - policy: qa-team
    on_approved:
      close_issue: true
      comment: "âœ… QA deployment approved!"

  deploy-stage:
    description: "Deploy to STAGING only"
    require:
      - policy: tech-leads
    on_approved:
      close_issue: true
      comment: "âœ… STAGING deployment approved!"

  deploy-prod:
    description: "Deploy to PRODUCTION only"
    require:
      - policy: production-approvers
    on_approved:
      create_tag: true
      close_issue: true
      comment: "ðŸš€ PRODUCTION deployment approved! Tag {{tag}} created."

  # Release workflow
  release:
    description: "Release approval"
    require:
      - policy: developers
    on_approved:
      create_tag: true
      close_issue: true
      comment: "Release approved! Tag {{tag}} created."
